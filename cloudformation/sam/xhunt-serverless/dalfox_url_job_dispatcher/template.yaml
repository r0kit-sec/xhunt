AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Dispatch jobs to the cluster

  Sample SAM Template for job-dispatcher

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 180

Parameters:
  DalfoxUrlsQueueName:
    Type: String
    Description: The name of the dalfox SQS queue.
  ECSTaskExecutionRoleARN:
    Type: String
    Description: The ARN for the task execution role to container will use in the ECS cluster during execution.
  XHuntToolsContainerRepositoryName:
    Type: String
    Description: The ECR repository name for the xhunt-tools container.
  JobQueue:
    Type: String
    Description: The job queue on the cluster to submit the job to


Resources:
  DalfoxUrlJobDispatcherFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: src/
      Handler: app.lambda_handler
      Runtime: python3.9
      Architectures:
      - x86_64
      Policies: 
        - AWSLambdaSQSQueueExecutionRole
        - AWSBatchServiceEventTargetRole
      Environment:
        Variables:
            TASK_CLUSTER_JOB_QUEUE_ARN: !Ref JobQueue
            TASK_CLUSTER_REFLECTED_XSS_JOB_DEFINITION_ARN: !Ref DalfoxUrlsJobDefinition

      # Configure event source mappings
      # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-property-function-sqs.html
      Events:
        DalfoxUrlsQueueEvent:
          Type: SQS
          Properties:
            Enabled: true
            Queue: !Sub 'arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:${DalfoxUrlsQueueName}'

  ## CLUSTER JOB DEFINITIONS ##
  DalfoxUrlsJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      ContainerProperties:
        Environment: []
        ExecutionRoleArn: !Ref ECSTaskExecutionRoleARN
        FargatePlatformConfiguration:
          PlatformVersion: LATEST
        Image:
          !Join
            - ''
            - - !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/
              - !Ref  XHuntToolsContainerRepositoryName
              - :latest
        LinuxParameters:
          Devices: []
          InitProcessEnabled: false
          Tmpfs: []
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-region: !Ref AWS::Region
            awslogs-group: /xhunt/task-cluster/dalfox-reflected-xss
            awslogs-create-group: true
          SecretOptions: []
        MountPoints: []
        NetworkConfiguration:
          AssignPublicIp: ENABLED
        ReadonlyRootFilesystem: false
        ResourceRequirements:
        - Type: VCPU
          Value: '1.0'
        - Type: MEMORY
          Value: '2048'
        Secrets: []
        Ulimits: []
        User: root
        Volumes: []
      JobDefinitionName: DalfoxReflectedXSS
      Parameters: {}
      PlatformCapabilities:
      - FARGATE
      RetryStrategy:
        Attempts: 1
        EvaluateOnExit: []
      Tags: {}
      Timeout:
        AttemptDurationSeconds: 1800
      Type: container


Outputs:
  DalfoxUrlsJobDefinitionARN:
    Value: !Ref DalfoxUrlsJobDefinition
    Export:
      Name: DalfoxUrlsJobDefinitionARN